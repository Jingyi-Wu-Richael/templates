arguments:
  parameters:
    - name: cvat-annotation-path
      value: annotation-dump/sample_dataset
      hint: Path to annotated data in default object storage. In CVAT, this parameter will be pre-populated.
      displayName: Dataset path
      visibility: internal

    - name: cvat-output-path
      value: workflow-data/output/sample_output
      hint: Path to store output artifacts in default object storage. In CVAT, this parameter will be pre-populated.
      displayName: Workflow output path
      visibility: internal

    - name: cvat-finetune-checkpoint
      value: ''
      hint: Select the last fine-tune checkpoint for this model. It may take up to 5 minutes for a recent checkpoint show here. Leave empty if this is the first time you're training this model.
      displayName: Checkpoint path
      visibility: public

    - name: cvat-num-classes
      displayName: Number of classes
      hint: Number of classes + 1 for background. In CVAT, this parameter will be pre-populated.
      value: '11'
      visibility: internal

    - name: hyperparameters
      displayName: Hyperparameters
      visibility: public
      type: textarea.textarea
      value: |-
        stage-1-epochs: 1    #  Epochs for network heads
        stage-2-epochs: 2    #  Epochs for finetune layers
        stage-3-epochs: 3    #  Epochs for all layers
        num_steps: 1000     #   Num steps per epoch
      hint: "See <a href='https://docs.onepanel.ai/docs/getting-started/use-cases/computervision/annotation/cvat/cvat_annotation_model#maskrcnn-hyperparameters' target='_blank'>documentation</a> for more information on parameters."

    - name: dump-format
      value: cvat_coco
      displayName: CVAT dump format
      visibility: public

    - displayName: Node pool
      hint: Name of node pool or group to run this workflow task
      type: select.nodepool
      visibility: public
      name: sys-node-pool
      value: default
      required: true

entrypoint: main
templates:
  - dag:
      tasks:
        - name: train-model
          template: tensorflow
    name: main
  - container:
      args:
        - |
          apt-get update \
          && apt-get install -y git wget libgl1-mesa-glx libsm6 libxext6 libxrender-dev \
          && pip install --upgrade pip \
          && pip install pycocotools numpy scipy scikit-image==0.16.2 imgaug pyyaml \
          && cd /mnt/src/train/workflows/maskrcnn-training \
          && python main.py train --dataset=/mnt/data/datasets \
            --model=workflow_maskrcnn \
            --extras="{{workflow.parameters.hyperparameters}}"  \
            --ref_model_path="{{workflow.parameters.cvat-finetune-checkpoint}}"  \
            --num_classes="{{workflow.parameters.cvat-num-classes}}"  \
            --logs=/mnt/output
      command:
        - sh
        - -c
      image: 'onepanel/dl:0.17.0'
      volumeMounts:
        - mountPath: /mnt/data
          name: data
        - mountPath: /mnt/output
          name: output
      workingDir: /mnt/src
    sidecars:
      - name: tensorboard
        image: tensorflow/tensorflow:2.4.0
        command: [ sh, -c ]
        env:
          - name: ONEPANEL_INTERACTIVE_SIDECAR
            value: 'true'
        args: [ "tensorboard --logdir /mnt/output/" ]
        ports:
          - containerPort: 6006
            name: tensorboard
    nodeSelector:
      beta.kubernetes.io/instance-type: '{{workflow.parameters.sys-node-pool}}'
    inputs:
      artifacts:
        - name: data
          path: /mnt/data/datasets/
          s3:
            key: '{{workflow.namespace}}/{{workflow.parameters.cvat-annotation-path}}'
        - name: models
          path: /mnt/data/models/
          optional: true
          s3:
            key: '{{workflow.parameters.cvat-finetune-checkpoint}}'
        - git:
            repo: https://github.com/onepanelio/templates.git
          name: src
          path: /mnt/src/train
    name: tensorflow
    outputs:
      artifacts:
        - name: model
          optional: true
          path: /mnt/output
          s3:
            key: '{{workflow.namespace}}/{{workflow.parameters.cvat-output-path}}/{{workflow.name}}'
volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 200Gi
  - metadata:
      name: output
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 200Gi
