entrypoint: main
arguments:
    parameters:
    - name: source
      value: https://github.com/onepanelio/templates
    - name: revision
      value: master
    - displayName: Node pool
      hint: Name of node pool or group to run this workflow task
      type: select.select
      visibility: public
      name: sys-node-pool
      value: Standard_D4s_v3
      required: true
      options:
      - name: 'CPU: 4, RAM: 16GB'
        value: Standard_D4s_v3
      - name: 'GPU: 1xV100, CPU: 6, RAM: 56GB'
        value: Standard_NC6s_v3
    
volumeClaimTemplates:
  - metadata:
      name: hyperparamtuning-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 20Gi
  - metadata:
      name: hyperparamtuning-output
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 20Gi
templates:
  - name: main
    dag:
      tasks:
      - name: hyperparameter-tuning
        template: hyperop
  
  - name: hyperop
    inputs:
      artifacts:
        - git:
            repo: '{{workflow.parameters.source}}'
            revision: '{{workflow.parameters.revision}}'
          name: src
          path: /mnt/data/src
    outputs:
      artifacts:
      - name: data
        path: /mnt/output
        optional: true
        archive:
          none: {}
    container:
      image: onepanel/nni:0.1.3_nni.1.9
      args:
      - --config
      - /mnt/data/src/workflows/nni-hyperparameter-tuning/mnist/config.yaml
      workingDir: /mnt
      volumeMounts:
      - name: hyperparamtuning-data
        mountPath: /mnt/data
      - name: hyperparamtuning-output
        mountPath: /mnt/output
    nodeSelector:
      beta.kubernetes.io/instance-type: '{{workflow.parameters.sys-node-pool}}'
    sidecars:
      - name: nni-hyperparamopt-ui
        image: 'onepanel/nni-proxy:0.0.1'
        env:
          - name: ONEPANEL_INTERACTIVE_SIDECAR
            value: 'true'
        ports:
          - containerPort: 9000
            name: nni